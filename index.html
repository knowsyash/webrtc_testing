<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>WebRTC Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .video-container {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .video-wrapper {
      flex: 1;
      min-width: 300px;
    }

    .video-wrapper h3 {
      margin-top: 0;
      text-align: center;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px 5px 0 0;
      margin-bottom: 0;
    }

    video {
      width: 100%;
      height: 300px;
      background: black;
      border: 2px solid #ccc;
      border-radius: 0 0 5px 5px;
      object-fit: cover;
    }

    input,
    button {
      margin: 5px;
      padding: 5px;
    }
  </style>
</head>

<body>
  <h2>WebRTC Video Call Demo</h2>

  <div class="video-container">
    <div class="video-wrapper">
      <h3>Your Camera (Local)</h3>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div class="video-wrapper">
      <h3>Remote Camera (Other Person)</h3>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>
  <div style="margin: 20px 0;">
    <button id="createCall"
      style="background: #4CAF50; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Create
      New Call</button>
  </div>

  <div id="callIdSection"
    style="display: none; margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 5px;">
    <h3>Your Call ID:</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
      <input type="text" id="generatedCallId" readonly
        style="font-size: 24px; font-weight: bold; padding: 10px; width: 200px; text-align: center; border: 2px solid #4CAF50; border-radius: 5px;">
      <button id="copyCallId"
        style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Copy
        ID</button>
    </div>
    <p style="color: #666; margin-top: 10px;">Share this ID with the person you want to call</p>
  </div>

  <div style="margin: 20px 0;">
    <h3>Join a Call:</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
      <input type="text" id="callIdInput" placeholder="Enter Call ID"
        style="padding: 10px; font-size: 16px; width: 200px; border: 2px solid #ccc; border-radius: 5px;">
      <button id="joinCall"
        style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Join
        Call</button>
    </div>
  </div>

  <div id="statusDisplay"
    style="margin: 20px 0; padding: 10px; background: #e8f5e8; border-radius: 5px; display: none;">
    <p id="statusText"></p>
  </div>

  <div id="permissionHelp"
    style="margin: 20px 0; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; display: none;">
    <h4 style="margin-top: 0; color: #856404;">ðŸ“¹ Camera & Microphone Permissions Required</h4>
    <p style="color: #856404; margin-bottom: 10px;">To use video calling, you need to allow camera and microphone
      access:</p>
    <ol style="color: #856404; margin-bottom: 10px;">
      <li>When prompted, click <strong>"Allow"</strong> (not "Block" or "Deny")</li>
      <li>If you see a camera icon in your browser's address bar, click it and select "Allow"</li>
      <li>If you accidentally blocked access, refresh the page and try again</li>
    </ol>
    <div style="display: flex; gap: 10px;">
      <button onclick="document.getElementById('permissionHelp').style.display='none'"
        style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Got
        it!</button>
      <button onclick="window.location.reload()"
        style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Refresh
        Page</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, get, onChildAdded, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // ----- Firebase config -----
    const firebaseConfig = {
      apiKey: "AIzaSyDGJvWk6h7JFtuqdsM4RNGJwiQj_ZUz9R8",
      authDomain: "rtc-project-sih.firebaseapp.com",
      databaseURL: "https://rtc-project-sih-default-rtdb.firebaseio.com/",
      projectId: "rtc-project-sih",
      storageBucket: "rtc-project-sih.appspot.com",
      messagingSenderId: "21024104436",
      appId: "1:21024104436:web:23cf8fe41b750d118ba3a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const createBtn = document.getElementById("createCall");
    const joinBtn = document.getElementById("joinCall");
    const callIdInput = document.getElementById("callIdInput");
    const callIdDisplay = document.getElementById("callIdDisplay");
    const callIdSection = document.getElementById("callIdSection");
    const generatedCallId = document.getElementById("generatedCallId");
    const copyCallIdBtn = document.getElementById("copyCallId");
    const statusDisplay = document.getElementById("statusDisplay");
    const statusText = document.getElementById("statusText");

    let pc;
    let localStream;
    let currentCallId;

    const servers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "turn:turn.anyfirewall.com:443?transport=tcp", username: "webrtc", credential: "webrtc" }
      ]
    };

    async function initMedia() {
      try {
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Browser does not support camera/microphone access');
        }

        showStatus("Please allow camera and microphone access when prompted...");

        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });

        // IMMEDIATELY set the local video source
        localVideo.srcObject = localStream;

        // Force the video to play
        try {
          await localVideo.play();
          console.log('Local video started playing successfully');
        } catch (playError) {
          console.log('Local video play failed, but continuing:', playError);
          // Don't throw error, just log it
        }

        console.log('Media initialized successfully');
        console.log('Local stream tracks:', localStream.getTracks().map(t => `${t.kind}: ${t.enabled}`));
        showStatus("Camera and microphone access granted!");

      } catch (error) {
        console.error('Error accessing media devices:', error);

        let errorMessage = "Error accessing camera/microphone. ";

        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMessage += "Please click 'Allow' when the browser asks for camera/microphone permissions. Then refresh the page and try again.";
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
          errorMessage += "No camera or microphone found. Please check your devices.";
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
          errorMessage += "Camera/microphone is already in use by another application.";
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
          errorMessage += "Camera/microphone settings not supported.";
        } else {
          errorMessage += "Please ensure permissions are granted and try again.";
        }

        showStatus(errorMessage, true);
        alert(errorMessage);
        throw error;
      }
    }

    function generateCallId() {
      // Generate a more user-friendly 6-character ID
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let id = "";
      for (let i = 0; i < 6; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    function showStatus(message, isError = false) {
      statusText.textContent = message;
      statusDisplay.style.display = 'block';
      statusDisplay.style.background = isError ? '#ffe8e8' : '#e8f5e8';
      console.log(message);
    }

    function hideStatus() {
      statusDisplay.style.display = 'none';
    }

    // Debug function to check video status
    function checkVideoStatus() {
      console.log('=== VIDEO STATUS CHECK ===');
      console.log('Local video element:', localVideo);
      console.log('Local video srcObject:', localVideo.srcObject);
      console.log('Local video readyState:', localVideo.readyState);
      console.log('Local video paused:', localVideo.paused);
      console.log('Remote video element:', remoteVideo);
      console.log('Remote video srcObject:', remoteVideo.srcObject);
      console.log('Remote video readyState:', remoteVideo.readyState);
      console.log('Remote video paused:', remoteVideo.paused);
      if (localStream) {
        console.log('Local stream tracks:', localStream.getTracks().map(t => `${t.kind}: ${t.enabled}`));
      }
      console.log('========================');
    }

    async function createPeerConnection(callId, isCaller) {
      try {
        pc = new RTCPeerConnection(servers);
        console.log('PeerConnection created for call:', callId, 'isCaller:', isCaller);

        // Add local tracks to peer connection
        localStream.getTracks().forEach(track => {
          console.log('Adding local track:', track.kind, track.enabled);
          pc.addTrack(track, localStream);
        });

        console.log('Local tracks added to peer connection');

        pc.ontrack = event => {
          console.log('Received remote track:', event.track.kind);
          console.log('Remote streams:', event.streams);

          // Handle the remote stream
          if (event.streams && event.streams[0]) {
            // Use the first stream from the event
            remoteVideo.srcObject = event.streams[0];
            console.log('Remote video stream set successfully from event.streams[0]');
            showStatus('Remote video connected!');
          } else {
            // Fallback: create stream from individual tracks
            console.log('Creating remote stream from track');
            if (!remoteVideo.srcObject) {
              remoteVideo.srcObject = new MediaStream();
            }
            remoteVideo.srcObject.addTrack(event.track);
            console.log('Remote track added to stream');
            showStatus('Remote video track added!');
          }

          // Ensure remote video plays
          remoteVideo.play().catch(e => console.log('Remote video play failed:', e));
        };

        pc.onconnectionstatechange = () => {
          console.log('Connection state:', pc.connectionState);
          if (pc.connectionState === 'connected') {
            showStatus('Video call connected successfully!');
          } else if (pc.connectionState === 'failed') {
            showStatus('Connection failed. Please try again.', true);
          } else if (pc.connectionState === 'connecting') {
            showStatus('Connecting to other person...');
          }
        };

        pc.oniceconnectionstatechange = () => {
          console.log('ICE connection state:', pc.iceConnectionState);
          if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
            showStatus('Successfully connected to other person!');
          } else if (pc.iceConnectionState === 'failed') {
            showStatus('Connection failed. Please check your internet and try again.', true);
          } else if (pc.iceConnectionState === 'checking') {
            showStatus('Checking connection...');
          } else if (pc.iceConnectionState === 'disconnected') {
            showStatus('Connection lost. Trying to reconnect...', true);
          }
        };

        const callRef = ref(db, "calls/" + callId);

        pc.onicecandidate = event => {
          if (event.candidate) {
            console.log('Sending ICE candidate:', event.candidate.candidate);
            const candidateKey = Date.now() + '_' + Math.random().toString(36).substring(2, 9);
            set(ref(db, `calls/${callId}/candidates/${candidateKey}`), event.candidate.toJSON());
          } else {
            console.log('ICE gathering completed');
          }
        };

        // Set up signaling listeners
        onChildAdded(ref(db, `calls/${callId}/signals`), async snapshot => {
          const data = snapshot.val();
          if (!data || !data.sdp) return;

          try {
            console.log('Received signal:', snapshot.key, data.sdp.type);

            if (data.sdp.type === "offer" && !isCaller) {
              // Joiner receives offer
              console.log('Joiner: Setting remote description (offer)');
              await pc.setRemoteDescription(data.sdp);
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              await set(ref(db, `calls/${callId}/signals/answer`), { sdp: pc.localDescription.toJSON() });
              console.log('Joiner: Answer sent');
              showStatus('Answer sent, waiting for connection...');
            } else if (data.sdp.type === "answer" && isCaller) {
              // Creator receives answer
              console.log('Creator: Setting remote description (answer)');
              await pc.setRemoteDescription(data.sdp);
              console.log('Creator: Answer processed');
              showStatus('Answer received, establishing connection...');
            }
          } catch (error) {
            console.error('Error handling signal:', error);
          }
        });

        // For joiners, check if there's already an offer waiting
        if (!isCaller) {
          setTimeout(async () => {
            try {
              const offerSnapshot = await get(ref(db, `calls/${callId}/signals/offer`));
              if (offerSnapshot.exists()) {
                const offerData = offerSnapshot.val();
                console.log('Joiner: Found existing offer');
                await pc.setRemoteDescription(offerData.sdp);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await set(ref(db, `calls/${callId}/signals/answer`), { sdp: pc.localDescription.toJSON() });
                console.log('Joiner: Answer sent to existing offer');
                showStatus('Connected to existing call...');
              }
            } catch (error) {
              console.error('Error checking for existing offer:', error);
            }
          }, 1000);
        }

        onChildAdded(ref(db, `calls/${callId}/candidates`), async snapshot => {
          const cand = snapshot.val();
          if (!cand) return;
          try {
            // Wait for remote description before adding candidates
            if (pc.remoteDescription) {
              await pc.addIceCandidate(cand);
              console.log('Added ICE candidate:', cand.candidate);
            } else {
              console.log('Waiting for remote description before adding candidate');
              // Store candidate to add later
              setTimeout(async () => {
                if (pc.remoteDescription) {
                  await pc.addIceCandidate(cand);
                  console.log('Added delayed ICE candidate:', cand.candidate);
                }
              }, 1000);
            }
          } catch (e) {
            console.warn('Failed to add ICE candidate:', e);
          }
        });

        if (isCaller) {
          // Small delay to ensure all listeners are set up
          setTimeout(async () => {
            try {
              console.log('Creator: Creating and sending offer...');
              const offer = await pc.createOffer();
              await pc.setLocalDescription(offer);
              await set(ref(db, `calls/${callId}/signals/offer`), { sdp: pc.localDescription.toJSON() });
              console.log('Creator: Offer created and sent to Firebase');
              showStatus('Waiting for other person to join...');
            } catch (error) {
              console.error('Error creating offer:', error);
              showStatus('Error creating call. Please try again.', true);
            }
          }, 500);
        } else {
          console.log('Joiner: Waiting for offer...');
          showStatus('Connecting to call...');
        }
      } catch (error) {
        console.error('Error creating peer connection:', error);
        alert('Error setting up connection. Please try again.');
      }
    }

    // Button event handlers
    createBtn.onclick = async () => {
      try {
        // Show permission help first
        document.getElementById('permissionHelp').style.display = 'block';

        showStatus("Click 'Allow' when prompted for camera/microphone access...");
        await initMedia();

        // CRITICAL: Ensure local video is visible IMMEDIATELY for creator
        console.log('Creator: Setting local video immediately after initMedia');
        localVideo.srcObject = localStream;
        await localVideo.play();
        console.log('Creator: Local video should be visible now');

        // Debug check
        setTimeout(() => checkVideoStatus(), 1000);

        currentCallId = generateCallId();
        generatedCallId.value = currentCallId;
        callIdSection.style.display = 'block';

        showStatus("Creating call...");
        await createPeerConnection(currentCallId, true);

        showStatus(`Call created! Share the Call ID: ${currentCallId}`);
        console.log('Call created with ID:', currentCallId);

        // Hide permission help once successful
        document.getElementById('permissionHelp').style.display = 'none';
      } catch (error) {
        console.error('Error creating call:', error);
        showStatus("Error creating call. Please allow camera/microphone access and try again.", true);
      }
    };

    joinBtn.onclick = async () => {
      try {
        const callId = callIdInput.value.trim().toUpperCase();
        if (!callId) {
          showStatus("Please enter a Call ID", true);
          return;
        }

        // Show permission help first
        document.getElementById('permissionHelp').style.display = 'block';

        showStatus("Click 'Allow' when prompted for camera/microphone access...");
        await initMedia();

        // CRITICAL: Ensure local video is visible IMMEDIATELY for joiner
        console.log('Joiner: Setting local video immediately after initMedia');
        localVideo.srcObject = localStream;
        await localVideo.play();
        console.log('Joiner: Local video should be visible now');

        // Debug check
        setTimeout(() => checkVideoStatus(), 1000);

        showStatus("Joining call...");
        currentCallId = callId;
        await createPeerConnection(callId, false);

        showStatus(`Joined call: ${callId}`);
        console.log('Joined call with ID:', callId);

        // Hide permission help once successful
        document.getElementById('permissionHelp').style.display = 'none';
      } catch (error) {
        console.error('Error joining call:', error);
        showStatus('Error joining call. Please allow camera/microphone access and try again.', true);
      }
    };

    // Copy Call ID functionality
    copyCallIdBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(currentCallId);
        showStatus("Call ID copied to clipboard!");
        setTimeout(hideStatus, 2000);
      } catch (error) {
        console.error('Error copying to clipboard:', error);
        // Fallback: select the text
        generatedCallId.select();
        generatedCallId.setSelectionRange(0, 99999);
        showStatus("Call ID selected. Press Ctrl+C to copy.");
      }
    };
  </script>
</body>

</html>
<!-- added -->