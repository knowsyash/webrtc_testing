<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Test</title>
</head>
<body>
  <h2>WebRTC Test</h2>
  <video id="localVideo" autoplay playsinline muted style="width: 45%;"></video>
  <video id="remoteVideo" autoplay playsinline style="width: 45%;"></video>
  <br><br>

  <button id="createCall">Create Call</button>
  <button id="joinCall">Join Call</button>
  <input type="text" id="callIdInput" placeholder="Enter Call ID to join">
  <p id="callIdDisplay"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://rtc-project-sih-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const createBtn = document.getElementById('createCall');
    const joinBtn = document.getElementById('joinCall');
    const callIdInput = document.getElementById('callIdInput');
    const callIdDisplay = document.getElementById('callIdDisplay');

    let localStream;
    let pc;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    async function initLocalStream() {
      if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      }
    }

    async function createPeerConnection(callId, isCaller) {
      pc = new RTCPeerConnection(servers);

      // Add local tracks
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // Create remote stream and attach
      const remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;
      pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));

      const callRef = ref(db, 'calls/' + callId + '/signals');

      pc.onicecandidate = event => {
        if (event.candidate) push(callRef, { candidate: event.candidate.toJSON() });
      };

      // Listen for signals
      onChildAdded(callRef, async snapshot => {
        const data = snapshot.val();
        if (!data) return;

        if (data.sdp) {
          const desc = new RTCSessionDescription(data.sdp);
          if (!pc.currentRemoteDescription) await pc.setRemoteDescription(desc);

          if (desc.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await push(callRef, { sdp: pc.localDescription.toJSON() });
          }
        } else if (data.candidate) {
          try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } 
          catch(e) { console.log(e); }
        }
      });

      if (isCaller) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await push(callRef, { sdp: pc.localDescription.toJSON() });
      }
    }

    createBtn.onclick = async () => {
      await initLocalStream();
      const callId = push(ref(db, 'calls')).key;
      callIdDisplay.innerText = 'Call ID: ' + callId;
      await createPeerConnection(callId, true);
    };

    joinBtn.onclick = async () => {
      const callId = callIdInput.value.trim();
      if (!callId) return alert('Enter Call ID');
      await initLocalStream();
      await createPeerConnection(callId, false);
    };
  </script>
</body>
</html>
