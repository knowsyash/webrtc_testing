<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebRTC Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .video-container {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .video-wrapper {
      flex: 1;
      min-width: 300px;
    }
    .video-wrapper h3 {
      margin-top: 0;
      text-align: center;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px 5px 0 0;
      margin-bottom: 0;
    }
    video {
      width: 100%;
      height: 300px;
      background: black;
      border: 2px solid #ccc;
      border-radius: 0 0 5px 5px;
      object-fit: cover;
    }
    input, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h2>WebRTC Video Call Demo</h2>
  
  <div class="video-container">
    <div class="video-wrapper">
      <h3>Your Camera (Local)</h3>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div class="video-wrapper">
      <h3>Remote Camera (Other Person)</h3>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>
  <div style="margin: 20px 0;">
    <button id="createCall" style="background: #4CAF50; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Create New Call</button>
  </div>
  
  <div id="callIdSection" style="display: none; margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 5px;">
    <h3>Your Call ID:</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
      <input type="text" id="generatedCallId" readonly style="font-size: 24px; font-weight: bold; padding: 10px; width: 200px; text-align: center; border: 2px solid #4CAF50; border-radius: 5px;">
      <button id="copyCallId" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Copy ID</button>
    </div>
    <p style="color: #666; margin-top: 10px;">Share this ID with the person you want to call</p>
  </div>

  <div style="margin: 20px 0;">
    <h3>Join a Call:</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
      <input type="text" id="callIdInput" placeholder="Enter Call ID" style="padding: 10px; font-size: 16px; width: 200px; border: 2px solid #ccc; border-radius: 5px;">
      <button id="joinCall" style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Join Call</button>
    </div>
  </div>
  
  <div id="statusDisplay" style="margin: 20px 0; padding: 10px; background: #e8f5e8; border-radius: 5px; display: none;">
    <p id="statusText"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, get, onChildAdded, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // ----- Firebase config -----
    const firebaseConfig = {
      apiKey: "AIzaSyDGJvWk6h7JFtuqdsM4RNGJwiQj_ZUz9R8",
      authDomain: "rtc-project-sih.firebaseapp.com",
      databaseURL: "https://rtc-project-sih-default-rtdb.firebaseio.com/",
      projectId: "rtc-project-sih",
      storageBucket: "rtc-project-sih.appspot.com",
      messagingSenderId: "21024104436",
      appId: "1:21024104436:web:23cf8fe41b750d118ba3a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const createBtn = document.getElementById("createCall");
    const joinBtn = document.getElementById("joinCall");
    const callIdInput = document.getElementById("callIdInput");
    const callIdDisplay = document.getElementById("callIdDisplay");
    const callIdSection = document.getElementById("callIdSection");
    const generatedCallId = document.getElementById("generatedCallId");
    const copyCallIdBtn = document.getElementById("copyCallId");
    const statusDisplay = document.getElementById("statusDisplay");
    const statusText = document.getElementById("statusText");

    let pc;
    let localStream;
    let currentCallId;

    const servers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "turn:turn.anyfirewall.com:443?transport=tcp", username: "webrtc", credential: "webrtc" }
      ]
    };

    async function initMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        console.log('Media initialized successfully');
      } catch (error) {
        console.error('Error accessing media devices:', error);
        alert('Error accessing camera/microphone. Please ensure permissions are granted.');
        throw error;
      }
    }

    function generateCallId() {
      // Generate a more user-friendly 6-character ID
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let id = "";
      for (let i = 0; i < 6; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    function showStatus(message, isError = false) {
      statusText.textContent = message;
      statusDisplay.style.display = 'block';
      statusDisplay.style.background = isError ? '#ffe8e8' : '#e8f5e8';
      console.log(message);
    }

    function hideStatus() {
      statusDisplay.style.display = 'none';
    }

    async function createPeerConnection(callId, isCaller) {
      try {
        pc = new RTCPeerConnection(servers);
        console.log('PeerConnection created for call:', callId, 'isCaller:', isCaller);

        const remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = event => {
          console.log('Received remote track');
          event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        };

        pc.onconnectionstatechange = () => {
          console.log('Connection state:', pc.connectionState);
        };

        pc.oniceconnectionstatechange = () => {
          console.log('ICE connection state:', pc.iceConnectionState);
        };

        const callRef = ref(db, "calls/" + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          const candidateKey = Date.now() + '_' + Math.random().toString(36).substring(2,9);
          set(ref(db, `calls/${callId}/candidates/${candidateKey}`), event.candidate.toJSON());
        }
      };

      onChildAdded(ref(db, `calls/${callId}/signals`), async snapshot => {
        const data = snapshot.val();
        if (!data || !data.sdp) return;

        try {
          if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(data.sdp);
            if (data.sdp.type === "offer") {
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              await set(ref(db, `calls/${callId}/signals/answer`), { sdp: pc.localDescription.toJSON() });
            }
          }
        } catch (error) {
          console.error('Error handling remote description:', error);
        }
      });

      onChildAdded(ref(db, `calls/${callId}/candidates`), async snapshot => {
        const cand = snapshot.val();
        if (!cand) return;
        try { 
          await pc.addIceCandidate(cand); 
          console.log('Added ICE candidate:', cand);
        } catch(e) {
          console.warn('Failed to add ICE candidate:', e);
        }
      });

        if (isCaller) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          await set(ref(db, `calls/${callId}/signals/offer`), { sdp: pc.localDescription.toJSON() });
          console.log('Offer created and sent');
        }
      } catch (error) {
        console.error('Error creating peer connection:', error);
        alert('Error setting up connection. Please try again.');
      }
    }

    // Button event handlers
    createBtn.onclick = async () => {
      try {
        showStatus("Accessing camera and microphone...");
        await initMedia();
        
        currentCallId = generateCallId();
        generatedCallId.value = currentCallId;
        callIdSection.style.display = 'block';
        
        showStatus("Creating call...");
        await createPeerConnection(currentCallId, true);
        
        showStatus(`Call created! Share the Call ID: ${currentCallId}`);
        console.log('Call created with ID:', currentCallId);
      } catch (error) {
        console.error('Error creating call:', error);
        showStatus("Error creating call. Please try again.", true);
      }
    };

    joinBtn.onclick = async () => {
      try {
        const callId = callIdInput.value.trim().toUpperCase();
        if (!callId) {
          showStatus("Please enter a Call ID", true);
          return;
        }
        
        showStatus("Accessing camera and microphone...");
        await initMedia();
        
        showStatus("Joining call...");
        currentCallId = callId;
        await createPeerConnection(callId, false);
        
        showStatus(`Joined call: ${callId}`);
        console.log('Joined call with ID:', callId);
      } catch (error) {
        console.error('Error joining call:', error);
        showStatus('Error joining call. Please check the Call ID and try again.', true);
      }
    };

    // Copy Call ID functionality
    copyCallIdBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(currentCallId);
        showStatus("Call ID copied to clipboard!");
        setTimeout(hideStatus, 2000);
      } catch (error) {
        console.error('Error copying to clipboard:', error);
        // Fallback: select the text
        generatedCallId.select();
        generatedCallId.setSelectionRange(0, 99999);
        showStatus("Call ID selected. Press Ctrl+C to copy.");
      }
    };
  </script>
</body>
</html>
